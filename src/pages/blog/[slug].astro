---
import Layout from '../../layouts/Layout.astro'
import Navbar from '../../components/Navbar.astro'
import ActionFooter from '../../components/ActionFooter.astro'
import {
	formatDate,
	calculateReadTime,
	processHtmlContent,
} from '../../utils/index'
import { convertLexicalToHTML } from '@payloadcms/richtext-lexical/html'
import { getLangFromUrl } from '../../i18n/utils'
import { Image } from 'astro:assets'

export async function getStaticPaths() {
	const PAYLOAD_URL =
		import.meta.env.PAYLOAD_URL || 'https://payload.wedit.tech'
	const res = await fetch(
		`${PAYLOAD_URL}/api/posts?where[tenant.id][equals]=2&limit=100`,
	)
	const posts = await res.json()

	return posts.docs.map((post: any) => ({
		params: { slug: post.slug },
	}))
}

const { slug } = Astro.params

if (slug === undefined) {
	throw new Error('Slug is required')
}

const lang = getLangFromUrl(Astro.url)
const PUBLIC_PAYLOAD_URL =
	import.meta.env.PAYLOAD_URL || 'https://payload.wedit.tech'

const response = await fetch(
	`${PUBLIC_PAYLOAD_URL}/api/posts?where[and][0][slug][equals]=${slug}&where[and][1][tenant.id][equals]=2`,
)
const data = await response.json()
const post = data.docs[0]

if (!post) {
	return Astro.redirect('/404')
}

const htmlContent = processHtmlContent(
	convertLexicalToHTML({
		data: post.content,
	}),
)

const readTime = calculateReadTime(post.content)
const formattedDate = formatDate(post.publishedAt, lang)

// Handle hero image URL
const imageObj = post.heroImage || post.meta?.image
let heroImageUrl = null

if (imageObj?.url) {
	const rawUrl = imageObj.url
	heroImageUrl = {
		src: rawUrl.startsWith('http')
			? rawUrl
			: `${PUBLIC_PAYLOAD_URL}${rawUrl}`,
		width: imageObj.width || 1920,
		height: imageObj.height || 1080,
		alt: imageObj.alt || post.title,
	}
}
---

<Layout title={`${post.title} | nexxos`} description={post.excerpt}>
	<Navbar />

	<article class='pt-32 pb-20 bg-brand-bone min-h-screen'>
		<div class='max-w-[800px] mx-auto px-6'>
			<!-- Header -->
			<header class='mb-12'>
				<div
					class='reveal inline-block bg-brand-blue/10 text-brand-blue text-xs font-bold px-3 py-1 rounded-full uppercase tracking-widest mb-6'
				>
					{formattedDate} â€¢ {readTime}
				</div>
				<h1
					class='reveal delay-100 text-5xl md:text-7xl font-bold text-brand-black leading-[0.9] tracking-tighter uppercase mb-8'
				>
					{post.title}
				</h1>
				{
					post.excerpt && (
						<p class='reveal delay-200 text-xl text-brand-black/70 leading-relaxed font-medium'>
							{post.excerpt}
						</p>
					)
				}
			</header>

			<!-- Hero Image -->
			{
				heroImageUrl && (
					<div class='reveal delay-300 mb-12 rounded-2xl overflow-hidden shadow-2xl'>
						<Image
							src={heroImageUrl.src}
							width={heroImageUrl.width}
							height={heroImageUrl.height}
							alt={heroImageUrl.alt}
							class='w-full h-auto object-cover'
						/>
					</div>
				)
			}

			<!-- Content -->
			<div class='reveal delay-500 prose prose-lg prose-brand max-w-none'>
				<div set:html={htmlContent} class='blog-content' />
			</div>

			<!-- Footer / Back links -->
			<div
				class='reveal delay-700 mt-20 pt-10 border-t border-brand-black/10'
			>
				<a
					href='/blog'
					class='inline-flex items-center text-sm font-bold uppercase tracking-widest text-brand-black hover:text-brand-blue transition-colors'
				>
					<svg
						xmlns='http://www.w3.org/2000/svg'
						class='w-4 h-4 mr-2'
						viewBox='0 0 24 24'
						fill='none'
						stroke='currentColor'
						stroke-width='2'
						stroke-linecap='round'
						stroke-linejoin='round'><path d='m15 18-6-6 6-6'></path></svg
					>
					Volver al blog
				</a>
			</div>
		</div>
	</article>

	<ActionFooter />
</Layout>

<style is:global>
	.blog-content {
		color: #0d0e14;
		line-height: 1.8;
	}
	.blog-content h2 {
		font-size: 2rem;
		font-weight: 700;
		margin-top: 3rem;
		margin-bottom: 1.5rem;
		text-transform: uppercase;
		letter-spacing: -0.02em;
	}
	.blog-content h3 {
		font-size: 1.5rem;
		font-weight: 700;
		margin-top: 2.5rem;
		margin-bottom: 1rem;
		text-transform: uppercase;
	}
	.blog-content p {
		margin-bottom: 1.5rem;
	}
	.blog-content ul {
		list-style-type: disc;
		padding-left: 1.5rem;
		margin-bottom: 1.5rem;
	}
	.blog-content ol {
		list-style-type: decimal;
		padding-left: 1.5rem;
		margin-bottom: 1.5rem;
	}
	.blog-content li {
		margin-bottom: 0.5rem;
	}
	.blog-content blockquote {
		border-left: 4px solid #ecfc39;
		padding-left: 1.5rem;
		font-style: italic;
		margin: 2rem 0;
		color: #4a4b52;
	}
	.blog-content img {
		border-radius: 1.5rem;
		margin: 2.5rem 0;
	}
</style>
