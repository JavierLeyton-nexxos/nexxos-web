---
import { Menu, X } from 'lucide-react'
import { getLangFromUrl, useTranslations, languages } from '../i18n/utils'
import { Image } from 'astro:assets'
import logo from '../assets/logo.png'

const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)

interface Props {
	theme?: 'transparent' | 'solid'
}

const { theme = 'transparent' } = Astro.props

// Language Switcher Logic
const currentPath = Astro.url.pathname
function getPathForLang(l: string) {
	// If current path has a lang prefix, replace it. Otherwise prepend it.
	// Note: 'es' is default/root.

	const segments = currentPath.split('/').filter(Boolean)
	const supportedLangs = Object.keys(languages)
	const firstSegment = segments[0]

	let newSegments = [...segments]

	if (supportedLangs.includes(firstSegment)) {
		// We are in /en/ or /pt-br/
		if (l === 'es') {
			newSegments.shift() // Remove 'en' or 'pt-br' to go to root
		} else {
			newSegments[0] = l // Replace 'en' with 'pt-br' etc
		}
	} else {
		// We are in root (es)
		if (l !== 'es') {
			newSegments.unshift(l) // Add 'en' or 'pt-br'
		}
	}

	return '/' + newSegments.join('/')
}
---

<header
	id='navbar'
	data-theme={theme}
	class={`fixed top-0 w-full z-50 transition-all duration-300 rounded-b-[5px] ${theme === 'solid' ? 'bg-white shadow-sm' : 'bg-brand-bone/10 backdrop-blur-sm'}`}
>
	<div
		class='max-w-[1280px] mx-auto px-6 h-20 flex items-center justify-between'
	>
		<a
			href={lang === 'es' ? '/' : `/${lang}`}
			class='hover:opacity-80 transition-opacity z-50 relative'
		>
			<Image
				src={logo}
				alt='nexxos'
				class='h-8 w-auto'
				widths={[300, 600]}
				sizes='(max-width: 768px) 100vw, 300px'
			/>
		</a>

		<nav
			class='hidden md:flex gap-8 text-[11px] font-bold text-brand-black uppercase tracking-widest'
		>
			<a
				href={lang === 'es' ? '/infrastructure' : `/${lang}/infrastructure`}
				class='hover:text-brand-blue transition-colors'>{t('nav.infra')}</a
			>
		</nav>

		<!-- Desktop Actions -->
		<div class='hidden md:flex items-center gap-4'>
			<!-- Lang Switcher -->
			<div class='flex gap-2 text-[10px] uppercase font-bold tracking-wider'>
				{
					Object.keys(languages).map((l) => (
						<a
							href={getPathForLang(l)}
							class={`p-2 hover:text-brand-blue transition-colors ${lang === l ? 'text-brand-black underline decoration-2 underline-offset-4' : 'text-brand-gray'}`}
						>
							{l === 'pt-br' ? 'PT' : l.toUpperCase()}
						</a>
					))
				}
			</div>

			<a
				href={lang === 'es' ? '/contact' : `/${lang}/contact`}
				class='bg-brand-black text-white px-5 py-2 rounded-full font-bold text-[10px] tracking-widest uppercase hover:bg-brand-black/80 transition-colors'
			>
				{t('nav.invest')}
			</a>
		</div>

		<!-- Mobile Action Group -->
		<div class='flex md:hidden items-center gap-4'>
			<!-- Mobile Lang Switcher (Visible next to toggler) -->
			<div class='flex gap-2 text-[10px] uppercase font-bold tracking-wider'>
				{
					Object.keys(languages).map((l) => (
						<a
							href={getPathForLang(l)}
							class={`p-2 hover:text-brand-blue transition-colors ${lang === l ? 'text-brand-black underline decoration-2 underline-offset-4' : 'text-brand-gray'}`}
						>
							{l === 'pt-br' ? 'PT' : l.toUpperCase()}
						</a>
					))
				}
			</div>

			<!-- Mobile Menu Toggle -->
			<button
				id='mobile-menu-toggle'
				class='z-50 relative text-brand-black p-2'
				aria-label='Toggle Menu'
			>
				<span id='menu-open-icon' class='block'>
					<Menu className='w-6 h-6' />
				</span>
				<span id='menu-close-icon' class='hidden'>
					<X className='w-6 h-6' />
				</span>
			</button>
		</div>

		<!-- Mobile Menu Overlay -->
		<div
			id='mobile-menu'
			class='fixed top-20 left-0 right-0 bottom-0 bg-white z-40 flex-col items-center justify-center gap-8 hidden md:hidden'
		>
			<nav
				class='flex flex-col items-center gap-8 text-xl font-bold uppercase tracking-widest'
			>
				<a
					href={lang === 'es'
						? '/infrastructure'
						: `/${lang}/infrastructure`}
					class='hover:text-brand-blue transition-colors'
					>{t('nav.infra')}</a
				>
			</nav>

			<div class='flex flex-col items-center gap-8'>
				<a
					href={lang === 'es' ? '/contact' : `/${lang}/contact`}
					class='bg-brand-black text-white px-8 py-3 rounded-full font-bold text-sm tracking-widest uppercase hover:bg-brand-black/80 transition-colors'
				>
					{t('nav.invest')}
				</a>
			</div>
		</div>
	</div>
</header>

<script>
	const nav = document.getElementById('navbar')
	const menuToggle = document.getElementById('mobile-menu-toggle')
	const mobileMenu = document.getElementById('mobile-menu')
	const openIcon = document.getElementById('menu-open-icon')
	const closeIcon = document.getElementById('menu-close-icon')

	if (nav && nav.dataset.theme !== 'solid') {
		window.addEventListener('scroll', () => {
			if (window.scrollY > 10) {
				nav.classList.add('bg-white', 'shadow-sm')
				nav.classList.remove('bg-brand-bone/10', 'backdrop-blur-sm')
			} else {
				nav.classList.remove('bg-white', 'shadow-sm')
				nav.classList.add('bg-brand-bone/10', 'backdrop-blur-sm')
			}
		})
	}

	// Mobile Menu Toggle Logic
	if (menuToggle && mobileMenu && openIcon && closeIcon && nav) {
		menuToggle.addEventListener('click', () => {
			const isHidden = mobileMenu.classList.contains('hidden')

			if (isHidden) {
				// Open
				mobileMenu.classList.remove('hidden')
				mobileMenu.classList.add('flex')
				openIcon.classList.add('hidden')
				closeIcon.classList.remove('hidden')
				nav.classList.add('bg-white') // Force solid bg
				nav.classList.remove('bg-brand-bone/10', 'backdrop-blur-sm')
				document.body.style.overflow = 'hidden' // Prevent scrolling
			} else {
				// Close
				mobileMenu.classList.add('hidden')
				mobileMenu.classList.remove('flex')
				openIcon.classList.remove('hidden')
				closeIcon.classList.add('hidden')

				// Restore bg if at top
				if (window.scrollY <= 10 && nav.dataset.theme !== 'solid') {
					nav.classList.remove('bg-white')
					nav.classList.add('bg-brand-bone/10', 'backdrop-blur-sm')
				}

				document.body.style.overflow = '' // Restore scrolling
			}
		})
	}
</script>
